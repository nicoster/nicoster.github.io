---
id: 147
title: Narrator.dll 的实现
date: 2006-12-03T16:55:00+00:00
author: nick
layout: post
guid: http://nick.luckygarden.org/?p=147
permalink: /narrator-dll-%e7%9a%84%e5%ae%9e%e7%8e%b0/
categories:
  - Uncategorized
tags:
  - atl
  - bho
  - narrator
---
 常常看英文网页. 有不少单词不认识, 甚至不知道如何发音. 也有软件可以翻译. 比如 googletoolbar, 还支持屏幕取词. 而金山词霸的一些版本也可以发音. 但它太庞大了. 我只要一个小小的发音功能. 犯不着. 这个时候, 往往我将这个词粘贴到控制面板的 speech applet, 让 windows 给我读出来. 虽然声音很糟糕. 毕竟是免费的午餐. 至少能知道单词是怎么读的.这个操作虽然简单. 但次数一多, 就有些厌烦了. 因此, 就有了写一个 IE 插件的想法. 比如选中一个单词. 点击工具栏上的一个按钮. 电脑就帮你读出来. nice idea!
有两个问题需要解决.. 怎么使用微软的 speech.. 怎么创建 Internet Explorer 插件.
对于第一个问题. 我找到了 Microsoft Speech SDK 5.1, 居然是微软 2001 年发布的. 还是使用经典的 COM, 没有 .NET 这么先进. 附带了不少例子. 其中的 TalkBack 是一个简单的 console 程序. 先识别语言. 然后再读出来. 而我只需要读出来 (Text To Speech). 就在这个例子上面修改吧. 几行代码就可以高定. 如下:
 CComPtr<ISpVoice> cpVoice; hr = cpVoice.CoCreateInstance(CLSID_SpVoice);  if (SUCCEEDED(hr)) {  cpVoice->Speak( L "What can I say? ", SPF_DEFAULT, NULL); }
第二个问题费了一些时间. 首先我想到的就是 IE toolbar, IE toolbar 现在的名气很大. 很多流氓软件都用这个. 在 IE 上增加一个工具栏, 可以加上想要的通用控件, 比如工具栏按钮什么的. 但没有告诉我如何获取网页上选中的文本. 然后我又找到了 BHO. 也是一个 in-proc COM 组件. 通常没有界面. 还有一篇很好的文章介绍这个:   <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnwebgen/html/bho.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnwebgen/html/bho.asp</a>   Browser Helper Objects: The Browser the Way You Want It
还提供了例子代码. 加上另一篇文章:   <a href="http://www.cnblogs.com/hbifts/articles/24265.html">http://www.cnblogs.com/hbifts/articles/24265.html</a>   VC++开发BHO插件&mdash;&mdash;定制你的浏览器   另外, 还找到了一个如何从网页获取选中文本的脚本. 就是这么简单:   document.selection.createRange().text;
其中的 document 是 dhtml 中的文档对象. 我要做的只是把它翻译程 C++. 就象这样(为了简洁, 去掉了错误处理): mWebBrowser2->get_Document(&pDisp); CComQIPtr<IHTMLDocument2, &IID_IHTMLDocument2> spHTML = pDisp;  if (spHTML) {  CComPtr<IHTMLSelectionObject> selectObj;  spHTML->get_selection(&selectObj);  if (selectObj)  {   CComPtr<IDispatch> iDispRange;   selectObj->createRange(&iDispRange);   CComQIPtr<IHTMLTxtRange> range(iDispRange);   if (range)   {    BSTR bstrSelection;    range->get_text(&bstrSelection);        mcpVoice->Speak(bstrSelection, SPF_ASYNC, NULL);   }  } } 有了这些. 已经可以实现我的想法了.  
于是, 就有了这个 narrator.dll. 在 IE 里遇到不知道如何读的单词. 选中它. 然后按 F2 (预定义的快捷键), 电脑就会读出这个单词. 
Known Problems:. 基于 Microsoft 的语言引擎, 只要 xp 及其以上采用安装, 所以, 默认情况下, 只支持 xp (极其以上). 默认情况下, 不支持中文阅读. 如果您选中了一大段英文文本, 他会一直念到最后. 不能中断. 还不能自定义键(偷懒)
Un/Installation:. 拷贝到 windows 目录. 然后在开始/运行 执行 regsvr32 narrator.dll 来安装.. 卸载: 在开始/运行 执行 regsvr32 /u narrator.dll, 然后删除 windows 目录的 narrator.dll. 绝对没有残留.
 <a href="http://nicoster.googlepages.com/narrator.rar">http://nicoster.googlepages.com/narrator.rar</a>
<hr />
 如果只要求右键菜单触发, 那么就忘掉上面说得那么多吧. no ATL, no C++, just scripts
<div style="BORDER-RIGHT: windowtext 0.5pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 0.5pt solid; PADDING-LEFT: 5.4pt; BACKGROUND: #e6e6e6; PADDING-BOTTOM: 4px; BORDER-LEFT: windowtext 0.5pt solid; WIDTH: 95%; WORD-BREAK: break-all; PADDING-TOP: 4px; BORDER-BOTTOM: windowtext 0.5pt solid">
<div><img id="_28_148_Open_Image" onclick="this.style.display='none'; document.getElementById('_28_148_Open_Text').style.display='none'; document.getElementById('_28_148_Closed_Image').style.display='inline'; document.getElementById('_28_148_Closed_Text').style.display='inline';" alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBlockStart.gif" /><img id="_28_148_Closed_Image" style="DISPLAY: none" onclick="this.style.display='none'; document.getElementById('_28_148_Closed_Text').style.display='none'; document.getElementById('_28_148_Open_Image').style.display='inline'; document.getElementById('_28_148_Open_Text').style.display='inline';" alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ContractedBlock.gif" /><span style="COLOR: #0000ff"><</span><span style="COLOR: #800000">script </span><span style="COLOR: #ff0000">language</span><span style="COLOR: #0000ff">= "vbscript "</span><span style="COLOR: #0000ff">></span><span id="_28_148_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">&#8230;</span><span id="_28_148_Open_Text"><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5"><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif" /></span><span style="COLOR: #0000ff; BACKGROUND-COLOR: #f5f5f5">set</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5"> oVoice </span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5">=</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5"> </span><span style="COLOR: #0000ff; BACKGROUND-COLOR: #f5f5f5">CreateObject</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5">(</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5"> "</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5">Sapi.SpVoice</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5"> "</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5">)<img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBlockEnd.gif" />oVoice.Speak external.menuArguments.document.selection.createRange().text , </span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5">2</span><span style="COLOR: #000000; BACKGROUND-COLOR: #f5f5f5"><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" /></span></span><span style="COLOR: #0000ff"></</span><span style="COLOR: #800000">script</span><span style="COLOR: #0000ff">></span><span style="COLOR: #000000"><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" /></span></div>
</div>
<div style="BORDER-RIGHT: windowtext 0.5pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 0.5pt solid; PADDING-LEFT: 5.4pt; BACKGROUND: #e6e6e6; PADDING-BOTTOM: 4px; BORDER-LEFT: windowtext 0.5pt solid; WIDTH: 95%; WORD-BREAK: break-all; PADDING-TOP: 4px; BORDER-BOTTOM: windowtext 0.5pt solid">
<div><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" /><span style="COLOR: #000000">Windows Registry Editor Version </span><span style="COLOR: #000000">5.00</span><span style="COLOR: #000000"><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" /><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" />[HKEY_CURRENT_USERSoftwareMicrosoftInternet ExplorerMenuExt</span><span style="COLOR: #000000">&</span><span style="COLOR: #000000">Say it]<img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" />@</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000"> "</span><span style="COLOR: #000000">d:\narrator.htm</span><span style="COLOR: #000000"> "</span><span style="COLOR: #000000"><img alt="" align="top" src="http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif" /></span><span style="COLOR: #000000"> "</span><span style="COLOR: #000000">contexts</span><span style="COLOR: #000000"> "</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">dword:</span><span style="COLOR: #000000">00000010</span></div>
</div>
<font size="2">注意注册表文件的路径, 这里假设你把 narrator.thm 放到了 d:</font>
<img alt="" src="http://nicoster.googlepages.com/narrator_htm.png" />
<a href="http://nicoster.googlepages.com/narrator_setup.rar">http://nicoster.googlepages.com/narrator_setup.rar</a>
